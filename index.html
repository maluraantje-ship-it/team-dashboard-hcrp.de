<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Abmeldung & Team-Log System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #2c2f33;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: #36393f;
      padding: 30px;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    }
    h1 { text-align: center; color: #7289da; }
    label { display: block; margin: 15px 0 5px; font-weight: bold; }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #202225;
      border-radius: 6px;
      background: #2f3136;
      color: white;
      box-sizing: border-box;
    }
    .field { display: none; } /* Dynamische Felder verstecken */
    .buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
    }
    button {
      padding: 14px 28px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #5865f2;
      color: white;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(88,101,242,0.4);
      background: #4752c4;
    }
    button:active {
      transform: translateY(1px);
    }
    #status {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
    }
    .success { color: #43b581; }
    .error   { color: #f04747; }
    #authSection { text-align: center; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="container">
  <h1>Abmeldung & Team-Log System</h1>

  <div id="authSection" style="display: none;">
    <p>Du musst dich mit Discord anmelden, um fortzufahren.</p>
    <button id="loginBtn">Mit Discord anmelden</button>
  </div>

  <form id="logForm" style="display: none;">
    <!-- Das Formular aus vorher (Dropdown, Felder, etc.) -->
    <label for="aktion">Aktion auswählen:</label>
    <select id="aktion" required>
      <option value="">-- Wähle eine Aktion --</option>
      <option value="abmeldung">Abmeldung</option>
      <option value="teamwarn">Teamwarn</option>
      <option value="teamkick">Teamkick</option>
      <option value="einstellung">Einstellung</option>
      <option value="uprank">Uprank</option>
      <option value="downrank">Downrank</option>
    </select>

    <!-- Gemeinsame Felder -->
    <div id="grundField" class="field">
      <label for="grund">Grund:</label>
      <textarea id="grund" rows="4"></textarea>
    </div>

    <div id="datumField" class="field">
      <label for="datum">Datum:</label>
      <input type="date" id="datum">
    </div>

    <div id="werField" class="field">
      <label for="wer">Wer (User / Nick):</label>
      <input type="text" id="wer">
    </div>

    <div id="vonField" class="field">
      <label for="von">Von (Moderator):</label>
      <input type="text" id="von">
    </div>

    <!-- Spezifische Felder -->
    <div id="abField" class="field">
      <label for="ab">Ab wann:</label>
      <input type="date" id="ab">
    </div>

    <div id="bisField" class="field">
      <label for="bis">Bis wann:</label>
      <input type="date" id="bis">
    </div>

    <div id="abgesprochenField" class="field">
      <label for="abgesprochen">Abgesprochen mit:</label>
      <input type="text" id="abgesprochen">
    </div>

    <div id="neueRolleField" class="field">
      <label for="neueRolle">Neue Rolle:</label>
      <input type="text" id="neueRolle">
    </div>

    <div id="alteRolleField" class="field">
      <label for="alteRolle">Alte Rolle:</label>
      <input type="text" id="alteRolle">
    </div>

    <div class="buttons">
      <button type="submit">Absenden</button>
      <button type="reset">Zurücksetzen</button>
    </div>
  </form>

  <div id="status"></div>
</div>

<script>
  const form = document.getElementById('logForm');
  const statusDiv = document.getElementById('status');
  const aktionSelect = document.getElementById('aktion');
  const authSection = document.getElementById('authSection');
  const loginBtn = document.getElementById('loginBtn');

  // Deine Discord Client ID (aus Developer Portal)
  const clientId = 'DEINE_CLIENT_ID_HIER_EINFÜGEN';
  const guildId = 'DEINE_GUILD_SERVER_ID_HIER_EINFÜGEN'; // Server-ID
  const roleId = '1470004099129933829'; // High-Team Rolle
  const redirectUri = window.location.href; // Aktuelle Seite als Redirect

  // Felder wie vorher
  const fields = {
    grund: document.getElementById('grundField'),
    datum: document.getElementById('datumField'),
    wer: document.getElementById('werField'),
    von: document.getElementById('vonField'),
    ab: document.getElementById('abField'),
    bis: document.getElementById('bisField'),
    abgesprochen: document.getElementById('abgesprochenField'),
    neueRolle: document.getElementById('neueRolleField'),
    alteRolle: document.getElementById('alteRolleField')
  };

  // Felder anzeigen wie vorher
  aktionSelect.addEventListener('change', (e) => {
    // ... der Code aus vorher für Felder anzeigen ...
  });

  // Auth-Check beim Laden
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  if (code) {
    getAccessToken(code);
  } else {
    checkAuth();
  }

  // Funktion zum Token holen (braucht Backend!)
  async function getAccessToken(code) {
    statusDiv.textContent = '⏳ Authentifizierung läuft...';
    try {
      // Hier müsste ein Backend-Aufruf sein, z. B. fetch('/api/get-token', { method: 'POST', body: JSON.stringify({code}) })
      // Für Demo annehmen, dass wir Token haben und prüfen
      // In echt: Sende code an deinen Server, der den Token tauscht und Rollen prüft
      const accessToken = 'BEISPIEL_TOKEN'; // Placeholder – in echt von Backend
      const hasRole = await checkRole(accessToken);
      if (hasRole) {
        localStorage.setItem('discord_access', 'valid');
        window.location.search = ''; // Code aus URL entfernen
        checkAuth();
      } else {
        statusDiv.textContent = '❌ Kein Zugriff – falsche Rolle';
        statusDiv.className = 'error';
      }
    } catch (err) {
      statusDiv.textContent = '❌ Auth-Fehler';
      statusDiv.className = 'error';
    }
  }

  async function checkRole(accessToken) {
    const response = await fetch(`https://discord.com/api/users/@me/guilds/${guildId}/member`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const member = await response.json();
    return member.roles.includes(roleId);
  }

  function checkAuth() {
    if (localStorage.getItem('discord_access') === 'valid') {
      authSection.style.display = 'none';
      form.style.display = 'block';
    } else {
      authSection.style.display = 'block';
      form.style.display = 'none';
    }
  }

  loginBtn.addEventListener('click', () => {
    const scope = 'identify guilds guilds.members.read';
    const url = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${encodeURIComponent(scope)}`;
    window.location.href = url;
  });

  // Submit-Handler wie vorher
  form.addEventListener('submit', async (e) => {
    // ... der Code aus vorher für Submit ...
  });
</script>

</body>
</html>
